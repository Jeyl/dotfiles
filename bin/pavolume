#!/bin/sh

set -e

dump="$(pacmd dump)"
device="$(echo "$dump" | grep -E "^set-default-sink " | cut -f 2- -d " ")"
step="3277"

status() {
	if echo "$dump" | grep -x "set-sink-mute $device no" >/dev/null ; then
		rawVol="$(echo "$dump" | sed -n 's/set-sink-volume '${device}' \(.*\)/\1/p')"
		echo "$(( $rawVol * 100 / 0xFFFF ))%"
	else
		echo "mute"
	fi
}

changeVolume() {
	local DIR="$1"
	local CMP="$2"
	local MAX="$3"
	
	echo "$dump" | \
	awk --non-decimal-data \
'$1~/set-sink-volume/{'\
'	if ($2~/'$device'/) {'\
'		if ($3'"$DIR $step $CMP $MAX"') {'\
'			system ("pactl "$1" '$device' "'$MAX')'\
'		}'\
'		else {'\
'			system ("pactl "$1" '$device' "$3'"$DIR $step"')'\
'		}'\
'	}'\
'}'
}

case "$1" in
	"up")
		changeVolume "+" ">" "65535"
		killall --quiet -USR1 i3status
		;;
	"down")
		changeVolume "-" "<" "0"
		killall --quiet -USR1 i3status
		;;
	"mute")  # toggle mute
		if echo "$dump" | grep -x "set-sink-mute $device yes" >/dev/null ; then
			pactl "set-sink-mute" "$device" "no"
		else
			pactl "set-sink-mute" "$device" "yes"
		fi
		killall --quiet -USR1 i3status
		;;
	*)
		status
		;;
esac
