#!/bin/bash
## Bash required for truncating variables

set -e

## Set the pwd to the project root, so we can savely use relative path names
cd "$(dirname "$0")/.."
export DOT_DIR="$(pwd)"
mkdir -p "$HOME/.dot"
echo "$DOT_DIR" >"$HOME/.dot/dir"

. share/console_setup


newPreparation() {
	local SRC="$1"
	local DST="$2"
	
	shift
	shift
	
	## Stop here, if the destination file is on the no-fly list.
	if grep \
		--fixed-strings --line-regexp \
		"$DST" \
		"$HOME/.dot/not" \
		>/dev/null 2>&1
	then
		return
	fi
	
	## Make a backup of the destination file, if it already exists
	if [ -e "$HOME/$DST" ] ; then
		mkdir -p "$(dirname "$BAK/${DST:1}")"
		ln "$HOME/$DST" "$BAK/${DST:1}"
	fi
	
	## Create the directory for the destination file
	mkdir -p "$(dirname "$HOME/$DST")"
	
	## Execute the passed command if the source and destination files differ
	## (so the backup hard links make sense)
	if ! cmp -s "$SRC" "$HOME/$DST" ; then
		rm "$HOME/$DST"
		"$@" "$SRC" "$HOME/$DST"
	fi
}


newCopy() {
	newPreparation "$1" "$2" cp
}


newLink() {
	newPreparation "$1" "$2" ln -fs
}


## Create backups
BAK="$HOME/.dot/backup/$(date "+%F_%T")"

if [ -d "$HOME/.dot/backup" ] ; then
	ls "$HOME/.dot/backup" -r | awk "NR>10" | xargs --no-run-if-empty rm
fi


case "$S_DOMAIN" in
	"cip.ifi.lmu.de")
		rbg_fix="_local"
		;;
esac


## Create directories
find dotfiles -type f | while read SRC ; do
	DST=".${SRC:9}"
	sed -e "s#--DOT_DIR--#$DOT_DIR#g" <"$SRC" >"$HOME/.dot/tmp"
	newCopy "$HOME/.dot/tmp" "$DST"
done

rm "$HOME/.dot/tmp"


## ==== Setup programms ========================================================
## -- Console ------------------------------------------------------------------
newLink "share/console_setup" ".profile"         ## interactive & login
newLink "share/console_setup" ".bashrc$rbg_fix"  ## interactive & not login
newLink "share/console_setup" ".zshenv"          ## allways


## -- nano ---------------------------------------------------------------------
nanorc update


## -- git ----------------------------------------------------------------------
if type git >/dev/null ; then
	echo git config --global user.name "..."
	echo git config --global user.email "..."
	git config --global push.default "simple"
	git config --global color.ui "auto"

	if type kdiff3 >/dev/null ; then
		git config --global merge.tool "kdiff3"
	fi
fi

## -- i3 -----------------------------------------------------------------------
if type i3-msg >/dev/null ; then
	i3-msg --quiet reload
fi
