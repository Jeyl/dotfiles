#!/bin/bash
## Bash required for truncating variables

set -e

## Set the pwd to the project root, so we can savely use relative path names
cd "$(dirname "$0")/.."
export DOT_DIR="$(pwd)"
echo "$DOT_DIR" >"$HOME/.dotdir"

. share/console_setup


newPreparation() {
	if [ -e "$HOME/$2" ] ; then
		mkdir -p "$(dirname "$BAK/${2:1}")"
		ln "$HOME/$2" "$BAK/${2:1}"
	fi
	
	mkdir -p "$(dirname "$HOME/${2:1}")"
}

newCopy() {
	newPreparation "$1" "$2"
	cp "$DOT_DIR/$1" "$HOME/$2"
}


newLink() {
	newPreparation "$1" "$2"
	ln -fs "$DOT_DIR/$1" "$HOME/$2"
}


## Create backups
BAK="$HOME/.dotback/$(date "+%F_%T")"
ls "$HOME/.dotback" -r | awk 'NR>10' | xargs rm


case "$S_DOMAIN" in
	"cip.ifi.lmu.de")
		rbg_fix="_local"
		;;
esac


## Create directories
find dotfiles -type f | while read file ; do
	newCopy "$file" ".$file"
	sed -i -e "s#--DOT_DIR--#$DOT_DIR#g" "$HOME/.$file"
done


## Setup console
newLink "share/console_setup" ".profile"         ## interactive & login
newLink "share/console_setup" ".bashrc$rbg_fix"  ## interactive & not login
newLink "share/console_setup" ".zshenv"          ## allways


## Setup nano
nanorc update

if type i3-msg >/dev/null ; then
	i3-msg --quiet reload
fi
